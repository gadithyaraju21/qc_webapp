<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Medical Imaging QC</title>
    <link rel="stylesheet" href="common.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <script src="common.js"></script>
</head>
<body>
    <nav class="nav-bar">
        <ul>
            <li><a href="filter.html"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="database.html"><i class="fas fa-database"></i> Database</a></li>
            <li class="admin-only" style="display: none;"><a href="manage-users.html"><i class="fas fa-users-cog"></i> Manage Users</a></li>
            <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            <li><i class="fas fa-user"></i><span id="userStatus"></span></li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="filter-content card">
            <h1><i class="fas fa-brain"></i> Medical Imaging QC</h1>
            <h2>Select QC Type</h2>
            <p>Choose the type of quality control you want to perform.</p>
            <div class="button-group">
                <button class="button button-primary" onclick="selectQC('T1')">
                    <i class="fas fa-image"></i> QC T1 Images
                </button>
                <button class="button button-primary" onclick="selectQC('FLAIR')">
                    <i class="fas fa-image"></i> QC FLAIR Images
                </button>
                <button class="button button-primary" onclick="selectQC('LST_AI')">
                    <i class="fas fa-image"></i> QC LST AI (FLAIR with masks)
                </button>
            </div>
        </div>
    </div>
    <div id="message" class="message" style="display: none;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth().then((userInfo) => {
                if (userInfo) {
                    setUserStatus(userInfo.username, userInfo.isAdmin);
                }
            }).catch((error) => {
                console.error('Authentication check failed:', error);
                window.location.href = '/login.html';
            });
        });

        async function selectQC(qcType) {
            try {
                const response = await fetchWithAuth(`/patients-sessions?qcType=${qcType}`);
                const patientSessions = await response.json();

                if (patientSessions.length === 0) {
                    showMessage('No patient sessions available for this QC type.', 'warning');
                    return;
                }

                localStorage.setItem('currentQCType', qcType);
                localStorage.setItem('patientSessions', JSON.stringify(patientSessions));

                window.location.href = `qc.html?qcType=${qcType}`;
            } catch (error) {
                console.error('Error fetching patient sessions:', error);
                showMessage('Failed to fetch patient sessions. Please try again.', 'error');
            }
        }

        function showMessage(message, type = 'info') {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';

            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Review - Medical Imaging QC</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@niivue/niivue@0.38.0/dist/niivue.umd.js"></script>
    <script src="/common.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .image-panel {
            flex: 3;
            height: 100%;
            background-color: #000;
        }
        .control-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #f8f8f8;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        .patient-info {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .controls {
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="range"] {
            width: 100%;
        }
        .qc-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #007AFF;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.selected {
            background-color: #34C759;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }
        .nav-buttons .button {
            flex: 1;
            margin: 0 5px;
        }
        .nav-buttons .button:first-child {
            margin-left: 0;
        }
        .nav-buttons .button:last-child {
            margin-right: 0;
        }
        #gl {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body onload="checkAuth(); fetchPatientSessions();">
    <div class="container">
        <div class="image-panel">
            <canvas id="gl"></canvas>
        </div>
        <div class="control-panel">
            <div class="patient-info" id="patient-info">Patient: Loading... | Session: Loading...</div>
            <div class="controls">
                <div class="control-group">
                    <label for="sliceType">View:</label>
                    <select id="sliceType">
                        <option value="0">Axial</option>
                        <option value="1">Coronal</option>
                        <option value="2">Sagittal</option>
                        <option value="4">Render</option>
                        <option value="3" selected>A+C+S+R</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="maskOpacityRange">Mask Opacity:</label>
                    <input type="range" id="maskOpacityRange" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="control-group">
                    <label for="imageOpacityRange">Image Opacity:</label>
                    <input type="range" id="imageOpacityRange" min="0" max="1" step="0.1" value="1">
                </div>
            </div>
            <div class="qc-options">
                <button class="button" onclick="logQCOption('Ideal image')">Ideal image</button>
                <button class="button" onclick="logQCOption('Gadolinium')">Gadolinium</button>
                <button class="button" onclick="logQCOption('Severe artefacts')">Severe artefacts</button>
                <button class="button" onclick="logQCOption('Incorrect weighting')">Incorrect weighting</button>
                <button class="button" onclick="logQCOption('Lreg failure')">Lreg failure</button>
                <button class="button" onclick="logQCOption('Corrupted image')">Corrupted image</button>
            </div>
            <div class="nav-buttons">
                <button class="button" onclick="loadPrevious()">Previous</button>
                <button class="button" onclick="location.href='filter.html'">Home</button>
                <button class="button" style="background-color: #FF3B30;" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>
    <script>
         const nv1 = new niivue.Niivue({
            isResizeCanvas: true,
            dragAndDropEnabled: true
        });
        nv1.attachTo("gl");

        let patientSessions = [];
        let currentIndex = 0;
        let maskOpacity = 0.5;
        let imageOpacity = 1.0;
        const imageType = new URLSearchParams(window.location.search).get('imageType') || 'T1';

        async function fetchPatientSessions() {
            try {
                const response = await fetchWithAuth(`/patients-sessions?imageType=${imageType}`);
                const data = await response.json();
                console.log("Fetched patient sessions:", data);

                if (data.length > 0) {
                    patientSessions = data;
                    await loadPatientSession(currentIndex);
                } else {
                    console.error("No patient sessions found");
                    alert("No patient sessions found. Please check the server configuration.");
                }
            } catch (error) {
                console.error("Error fetching patient sessions:", error);
                alert(`Failed to fetch patient sessions: ${error.message}`);
            }
        }

        async function loadPatientSession(index) {
            const { patient, session } = patientSessions[index];
            document.getElementById("patient-info").textContent = `Patient: ${patient} | Session: ${session}`;

            try {
                const niftiResponse = await fetchWithAuth(`/nifti-files/${patient}/${session}?imageType=${imageType}`);
                const niftiFiles = await niftiResponse.json();

                const segmentationResponse = await fetchWithAuth(`/segmentation-files/${patient}/${session}`);
                const segmentationFiles = await segmentationResponse.json();

                if (niftiFiles.length > 0 && segmentationFiles.length > 0) {
                    await loadFiles(patient, session, niftiFiles[0], segmentationFiles[0]);
                    await highlightPreviousQCOption(patient, session, imageType);
                } else {
                    console.error("No files found", { niftiFiles, segmentationFiles });
                    alert("No files found for this patient session.");
                }
            } catch (error) {
                console.error("Error loading patient session files:", error);
                alert(`Failed to load patient session: ${error.message}`);
            }
        }

        async function loadFiles(patient, session, niftiFile, segmentationFile) {
            try {
                const [niftiResponse, segmentationResponse] = await Promise.all([
                    fetchWithAuth(`/nifti/${patient}/${session}/${niftiFile}`),
                    fetchWithAuth(`/segmentation/${patient}/${session}/${segmentationFile}`)
                ]);

                const [niftiBlob, segmentationBlob] = await Promise.all([
                    niftiResponse.blob(),
                    segmentationResponse.blob()
                ]);

                const niftiUrl = URL.createObjectURL(niftiBlob);
                const segmentationUrl = URL.createObjectURL(segmentationBlob);

                await nv1.loadVolumes([
                    { url: niftiUrl, name: niftiFile, colormap: "gray", opacity: imageOpacity },
                    { url: segmentationUrl, name: segmentationFile, colormap: "red", opacity: maskOpacity }
                ]);

                updateOpacityControls();
            } catch (error) {
                console.error("Error loading files:", error);
                alert(`Failed to load image files: ${error.message}`);
            }
        }

        function updateOpacityControls() {
            document.getElementById('maskOpacityRange').value = maskOpacity;
            document.getElementById('imageOpacityRange').value = imageOpacity;
        }

        function highlightSelectedOption(option) {
            document.querySelectorAll('.qc-options .button').forEach(button => {
                if (button.textContent === option) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }

        async function logQCOption(option) {
            const { patient, session } = patientSessions[currentIndex];
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0];
            const data = {
                patientID: patient,
                sessionID: session,
                option,
                imageType,
                date,
                time
            };
            try {
                const response = await fetchWithAuth('/log-qc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    highlightSelectedOption(option);
                    loadNext();
                }
            } catch (error) {
                console.error('Error logging QC option:', error);
                alert(`Failed to log QC option: ${error.message}`);
            }
        }

        async function highlightPreviousQCOption(patient, session, imageType) {
            try {
                const response = await fetchWithAuth(`/get-qc-log?patient=${patient}&session=${session}&imageType=${imageType}`);
                const data = await response.json();
                if (data.option) {
                    highlightSelectedOption(data.option);
                }
            } catch (error) {
                console.error("Error fetching QC log:", error);
            }
        }

        function highlightSelectedOption(option) {
            document.querySelectorAll('.qc-options .button').forEach(button => {
                button.style.backgroundColor = button.textContent === option ? 'var(--success-color)' : '';
            });
        }

        function loadNext() {
            currentIndex = (currentIndex + 1) % patientSessions.length;
            loadPatientSession(currentIndex);
        }

        function loadPrevious() {
            currentIndex = (currentIndex - 1 + patientSessions.length) % patientSessions.length;
            loadPatientSession(currentIndex);
        }

        document.getElementById('sliceType').addEventListener('change', (event) => {
            let st = parseInt(event.target.value);
            nv1.setSliceType(st);
        });

        document.getElementById('maskOpacityRange').addEventListener('input', function() {
            maskOpacity = parseFloat(this.value);
            nv1.volumes[1].opacity = maskOpacity;
            nv1.updateGLVolume();
        });

        document.getElementById('imageOpacityRange').addEventListener('input', function() {
            imageOpacity = parseFloat(this.value);
            nv1.volumes[0].opacity = imageOpacity;
            nv1.updateGLVolume();
        });
    </script>
</body>
</html>